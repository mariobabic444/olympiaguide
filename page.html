<template id="dialogMenu.html">
    <ons-dialog id="menu-dialog">
        <div style="text-align: center; padding: 10px;">
            <p>
                Beenden und zurück zum Hauptmenü?
            </p>
            <p>
                <ons-button onclick="hideMenuDialog(true)">Ok</ons-button>
                <ons-button onclick="hideMenuDialog(false)">Abbrechen</ons-button>
            </p>
        </div>
    </ons-dialog>
</template>
<template id="pageMap.html">
    <ons-page id="pageMap">
        <ons-toolbar>
            <div class="left">
                <ons-back-button>Zurück</ons-back-button>
            </div>
            <div class="center"></div>
        </ons-toolbar>
        <div style="width:100%;height:100%;" id="mapContainer"></div>
    </ons-page>
</template>
<template id="pageVideo.html">
    <ons-page id="pageVideo">
    </ons-page>
</template>
<template id="pageQuiz.html">
    <ons-page id="pageQuiz">
    </ons-page>
</template>
<template id="pageMapEnd.html">
    <ons-page id="pageMapEnd">
        <div id="mapContainerPage"></div>
    </ons-page>
</template>
<template id="pageStart.html">
    <ons-page id="pageStart" style="font-size: 7%">
        <ons-toolbar id="pageToolbar" style="height:7%;">
            <div class="center">
                <canvas style="width:100%; height:100%" id="progressBarCanvas">
                </canvas>
            </div>
        </ons-toolbar>
        <div id="menu"
             style="background-color:white;height:7%;width:100%; display: flex; align-items: center; justify-content : space-between;font-size: 7%">
            <button onclick="showMenuDialog()" style="margin-left:2px"
                    class="btn pmd-tooltip btn-sm pmd-btn-fab pmd-btn-flat pmd-ripple-effect btn-default home"
                    type="button" data-toggle="tooltip" title="Zurück zum Menü">
                <i class="material-icons pmd-sm">home</i>
            </button>
            <h2 style="text-align: center">Kapitel: Kapitelname</h2>
            <button style="margin-right:2px"
                    class="btn pmd-tooltip btn-sm pmd-btn-fab pmd-btn-flat pmd-ripple-effect btn-default map"
                    type="button" data-toggle="tooltip" title="Karte öffnen" id="buttonMap">
                <i class="material-icons pmd-sm">map</i>
            </button>
        </div>
    </ons-page>
</template>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="lib/css/onsenui.css">
    <link rel="stylesheet" href="lib/css/onsen-css-components.min.css">
    <link rel="stylesheet" href="lib/css/styles.css">
    <link rel="stylesheet" href="lib/css/bootstrap.css">
    <link rel="stylesheet" href="lib/css/propeller.css">
    <link rel="stylesheet" href="lib/js/leaflet/leaflet.css"/>
    <script src="lib/js/jquery.js"></script>
    <script src="lib/js/leaflet/leaflet.js"></script>
    <script src="lib/js/onsenui.min.js"></script>
    <script src="lib/js/fabric.js"></script>
    <script src="js/base.js"></script>
    <title>Olympiapark - Guide</title>
</head>
<body>
<ons-navigator swipeable id="myNavigator" page="pageStart.html"></ons-navigator>
</body>
</html>
<style>
    .home-item {
        width  : 50%;
        margin : 5%;
    }
</style>

<script>
    var showMenuDialog = function () {
        var dialog = document.getElementById('menu-dialog');

        if (dialog) {
            dialog.show();
        } else {
            ons.createElement('dialogMenu.html', {append: true})
                .then(function (dialog) {
                    dialog.show();
                });
        }
    };

    var hideMenuDialog  = function (returnToHome) {
        document
            .getElementById('menu-dialog')
            .hide();
        if (returnToHome) {
            window.location.href = "index.html"
        }
    };
    OlympiaGuide.Viewer = {
        map: undefined,
        mapPage: undefined,
        page: undefined,
        wayPoints:
            [
                {x: 48.18497338549956, y: 11.541051864624025},
                {x: 48.18274153384056, y: 11.545257568359377},
                {x: 48.180337892604314, y: 11.541051864624025},
                {x: 48.17827753898233, y: 11.54491424560547},
                {x: 48.17621710255478, y: 11.549463272094727},
                {x: 48.174442771499734, y: 11.55341148376465},
                {x: 48.16986356895716, y: 11.553754806518556},
                {x: 48.167860039256, y: 11.54963493347168},
            ],
        wayMarker: undefined,
        init: function () {
            document.addEventListener('init', function (event) {
                var page = event.target;
                OlympiaGuide.Viewer.load();
                if (page.id === 'pageStart') {
                    OlympiaGuide.Viewer.showMap(page);
                } else if (page.id === 'pageMap') {
                    page.querySelector('ons-toolbar .center').innerHTML = page.data.title;
                }
            });
        },
        showMap: function (page) {
            page.querySelector('#buttonMap').onclick = function () {
                document.querySelector('#myNavigator').pushPage('pageMap.html', {data: {title: 'Karte'}});
                setTimeout(function () {
                        OlympiaGuide.Viewer.renderMap();
                    }, 1
                );
            };
        },
        renderMap: function (mapMenu = true) {
            let corner1             = L.latLng(48.192583841140596, 11.56491279602051),
                corner2             = L.latLng(48.156925112380684, 11.532726287841799),
                bounds              = L.latLngBounds(corner1, corner2);
            let corner3             = L.latLng(48.18397192562091, 11.55641555786133),
                corner4             = L.latLng(48.16614266578527, 11.540322303771974),
                bounds2             = L.latLngBounds(corner3, corner4);
            OlympiaGuide.Viewer.map = L.map(
                mapMenu ? 'mapContainer' : 'mapContainerPage',
                {maxBounds: bounds}
            ).fitBounds(bounds2).setMaxBounds(bounds).setMinZoom(14);
            L.tileLayer(
                'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2Fwcmlzb25uZTE0IiwiYSI6ImNrZGV3N2lqZjA3dW8ycm81MG9rdXB1Y3oifQ.W7sx_PoGrYBPaYCGLQhKzA',
                {
                    id: 'mapbox/streets-v11',
                    accessToken: 'your.mapbox.access.token',
                }
            ).addTo(OlympiaGuide.Viewer.map);
            OlympiaGuide.Viewer.wayMarker = [];
            for (let i = 0; i < OlympiaGuide.Viewer.wayPoints.length; i++) {
                let icon                         = L.icon({
                    iconUrl: 'lib/js/leaflet/images/wayMarker/number_' + (i <= OlympiaGuide.Viewer.page ? 'marked_' : '') + (i + 1) + '.png',
                    iconAnchor: [15, 10]
                });
                OlympiaGuide.Viewer.wayMarker[i] = L.marker(
                    [OlympiaGuide.Viewer.wayPoints[i].x, OlympiaGuide.Viewer.wayPoints[i].y],
                    {icon: icon, draggable: true}
                ).addTo(OlympiaGuide.Viewer.map);
                OlympiaGuide.Viewer.wayMarker[i].bindPopup(L.popup({autoPanPaddingTopLeft: 170}).setContent(
                    "{Kapitel Name}"));
            }
        },
        load: function () {
            OlympiaGuide.Viewer.renderProgressCanvas();
        }
        ,
        renderProgressCanvas: function (page = 3) {
            OlympiaGuide.Viewer.page = page;
            var screenWidth          = document.getElementById('progressBarCanvas').getBoundingClientRect().width;
            var screenHeight         = document.getElementById('progressBarCanvas').getBoundingClientRect().height;
            var canvas               = new fabric.Canvas('progressBarCanvas');
            canvas.setWidth(screenWidth);
            canvas.setHeight(screenHeight);
            var i             = 0;
            var pageCount     = 8;
            var radius        = (screenWidth * 0.8 / pageCount) / 2;
            var margin        = screenWidth * 0.2 / 9;
            var oneStepWidth  = radius * 2 + screenWidth * 0.2 / 9;
            var left          = margin;
            var rectangleFill = new fabric.Rect({
                left: 0,
                top: 0,
                width: screenWidth,
                height: screenHeight,
                fill: 'white',
            });
            rectangleFill.set('selectable', false);
            canvas.add(rectangleFill);
            while (i < pageCount) {
                var left = left + oneStepWidth;
                if (i === 0) {
                    left = margin;
                } else if (i === pageCount - 1) {
                    left = screenWidth - radius * 2 - margin;
                }
                var circle = new fabric.Circle({
                    radius: radius, fill: i <= page ? '#0076ff' : '#b5b5b5', left: left, top: screenHeight / 2 - radius
                });
                circle.set('selectable', false);
                canvas.add(circle);
                var text = new fabric.Text((i + 1) + '', {
                    left: left + radius / 2,
                    top: screenHeight / 2 - radius,
                    fill: 'black',
                    fontSize: radius * 2,
                });
                text.set('selectable', false);
                canvas.add(text);
                i++;
            }
        }
        ,
    }
    ;
    OlympiaGuide.Viewer.init();
</script>
